<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PlanetForge — planet upgrades & cleaner orbits (fixed wheel + tests)</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: system-ui, sans-serif; }
    canvas { display:block; width:100vw; height:100vh; background: radial-gradient(circle at 50% 50%, #0b1220, #050910 60%, #03060b); }
    #hud { position: fixed; left: 12px; top: 12px; background: rgba(0,0,0,.6); color: #fff; padding: 10px 12px; border-radius: 12px; font-size: 14px; line-height: 1.35; }
    #hud button { margin-top: 6px; padding: 6px 10px; border: 0; border-radius: 8px; cursor: pointer; }
    #toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; background: rgba(0,0,0,.8); color:#fff; padding:10px 14px; border-radius: 10px; font-size: 14px; display:none; }
    #shop { position: fixed; right: 12px; top: 12px; background: rgba(0,0,0,.65); color:#fff; padding: 12px; border-radius: 12px; font-size: 14px; width: 340px; display:none; }
    #shop h3 { margin: 0 0 8px 0; font-size: 16px; }
    #shop section { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,.1); }
    #shop .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0; }
    #shop button, #shop input { margin: 0; padding: 6px 10px; border:0; border-radius:10px; }
    #shop input { width: 90px; }
    .muted { opacity:.75 }
    .kbd { background:#222; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #panel { position: fixed; left: 12px; bottom: 12px; background: rgba(0,0,0,.65); color:#fff; padding: 10px 12px; border-radius: 12px; font-size: 14px; display:none; min-width: 260px; }
    #panel .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:4px 0; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="hud">
    <div><strong>PlanetForge MVP</strong></div>
    <div>Planet Lv <span id="pLv">1</span> • Territory: <span id="terr">200</span>u</div>
    <div>Money: <span id="money">0</span></div>
    <div>Basalt: <span id="basalt">0</span> • Energy: <span id="energy">0</span></div>
    <div>Moons: <span id="moons">0</span> (+<span id="bRate">0</span>/s) • Satellites: <span id="sats">0</span> (+<span id="eRate">0</span>/s)</div>
    <div class="muted" style="margin-top:4px">R‑drag: pan • Wheel: zoom • <span class="kbd">H</span> shop • Click planet/buildings to manage • Drag from shop to choose orbit, then click to place</div>
    <button id="shopBtn">Open Shop</button>
  </div>

  <div id="shop">
    <h3>Shop</h3>
    <div class="muted">Buy buildings to place, then drag cursor to set orbit; click to confirm.</div>
    <section>
      <strong>Build</strong>
      <div class="row">
        <div>Moon — +1 basalt/s/level</div>
        <div>
          <span class="muted" id="moonCost">100</span>
          <button id="startMoon">Select</button>
        </div>
      </div>
      <div class="row">
        <div>Satellite — +1 energy/s/level</div>
        <div>
          <span class="muted" id="satCost">120</span>
          <button id="startSat">Select</button>
        </div>
      </div>
    </section>
    <section>
      <strong>Trade</strong>
      <div class="row">
        <div>Basalt → money</div>
        <div>
          <input id="sellBasaltAmt" type="number" min="0" step="1" placeholder="amount" />
          <button id="sellBasalt">Sell</button>
        </div>
      </div>
      <div class="row">
        <div>Energy → money</div>
        <div>
          <input id="sellEnergyAmt" type="number" min="0" step="1" placeholder="amount" />
          <button id="sellEnergy">Sell</button>
        </div>
      </div>
      <div style="text-align:right; margin-top:6px"><button id="closeShop">Close</button></div>
    </section>
  </div>

  <div id="panel">
    <div><strong id="panelTitle">Details</strong></div>
    <div class="row" id="rowLevel"><div>Level</div><div><span id="bLvl">1</span> / 10</div></div>
    <div class="row" id="rowProd"><div id="prodLabel">Prod</div><div><span id="bProd">+1</span></div></div>
    <div class="row" id="rowUpgrade"><div>Upgrade</div><div><button id="bUpgrade">Upgrade (<span id="bUpCost">—</span>)</button></div></div>
    <div class="row" id="rowDemo"><div>Demolish</div><div><button id="bDemo">Refund 75%</button></div></div>
    <div style="text-align:right; margin-top:6px"><button id="bClose">Close</button></div>
  </div>

  <div id="toast"></div>

  <script>
    // ---------- Canvas setup ----------
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    function resize(){
      cvs.width = Math.floor(innerWidth * DPR);
      cvs.height = Math.floor(innerHeight * DPR);
      cvs.style.width = innerWidth + 'px';
      cvs.style.height = innerHeight + 'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    addEventListener('resize', resize); resize();

    // ---------- Game state & economy ----------
    const STORAGE_KEY = 'planetforge:v3.1';
    const ECON = {
      startMoney: 20000, // testing boost
      moonCost: 100,
      satCost: 120,
      upgrade: { // cost to go from L -> L+1
        moonBase: 75, satBase: 90, planetBase: 500,
        mult: 1.5, planetMult: 1.4
      },
      sellUnit: { basalt: 1, energy: 1.2 }, // money per 1 unit
      territory: { base: 200, perLevel: 50, maxLevel: 10 },
      maxLevel: 10,
    };

    const defaultState = {
      planet: { x: 0, y: 0, radius: 32, level: 1 },
      territory: ECON.territory.base,
      moons: [], // {r, angle, speed, lvl, spent}
      sats: [],  // {r, angle, speed, lvl, spent}
      money: ECON.startMoney,
      basalt: 0,
      energy: 0,
      lastProd: Date.now(),
      lastFrame: Date.now(),
      cam: { x: -innerWidth/2, y: -innerHeight/2, zoom: 1 },
      placing: null, // {kind:'moon'|'sat', r:number, angle:number}
      selected: null, // {kind:'moon'|'sat'|'planet', idx?}
    };

    function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null } catch { return null } }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    let state = load() || structuredClone(defaultState);

    // ---------- Helpers ----------
    const cam = state.cam;
    const screenToWorld = (sx, sy) => ({ x: sx/cam.zoom + cam.x, y: sy/cam.zoom + cam.y });
    const worldToScreen = (wx, wy) => ({ x: (wx - cam.x)*cam.zoom, y:(wy - cam.y)*cam.zoom });

    const ORBIT = { min: 60, gap: 24, speedBase: 0.35 };
    function orbitSpeed(r){ return ORBIT.speedBase * (100 / Math.max(50, r)); }

    function upgradeCost(kind, lvl){
      if(kind==='moon') return Math.floor(ECON.upgrade.moonBase * Math.pow(ECON.upgrade.mult, Math.max(0,lvl-1)));
      if(kind==='sat')  return Math.floor(ECON.upgrade.satBase  * Math.pow(ECON.upgrade.mult, Math.max(0,lvl-1)));
      if(kind==='planet') return Math.floor(ECON.upgrade.planetBase * Math.pow(ECON.upgrade.planetMult, Math.max(0,lvl-1)));
      return 999999;
    }

    // ---------- Production ----------
    function accrue(){
      const now = Date.now();
      const dt = (now - state.lastProd)/1000; if (dt <= 0) return;
      state.lastProd = now;
      const moonRate = state.moons.reduce((s,m)=>s+m.lvl,0); // 1/s per level
      const satRate  = state.sats.reduce((s,m)=>s+m.lvl,0);
      state.basalt += moonRate * dt;
      state.energy += satRate * dt;
      state.basalt = Math.round(state.basalt * 1000)/1000;
      state.energy = Math.round(state.energy * 1000)/1000;
    }

    // ---------- Input & selection ----------
    let panning=false, last={x:0,y:0};
    cvs.addEventListener('contextmenu', e => e.preventDefault());

    cvs.addEventListener('mousedown', (e)=>{
      if(e.button===2){ panning=true; last.x=e.clientX; last.y=e.clientY; return; }
      if(e.button===0){
        // Placing commitment
        if(state.placing){
          if(isPlacementValid(state.placing.r)){
            const k = state.placing.kind;
            const base = (k==='moon'? ECON.moonCost : ECON.satCost);
            if(state.money < base) { toast('Not enough money.'); return; }
            state.money -= base;
            const obj = { r: state.placing.r, angle: state.placing.angle, speed: orbitSpeed(state.placing.r), lvl:1, spent: base };
            (k==='moon'? state.moons : state.sats).push(obj);
            state.placing=null; updateHud(); save();
          } else { toast('Invalid orbit — overlaps or outside territory.'); }
          return;
        }
        // Selection: building or planet (canvas only)
        const world = screenToWorld(e.clientX, e.clientY);
        const hit = pickBuilding(world.x, world.y);
        if(hit){ state.selected = hit; updatePanel(); return; }
        const dx = world.x - state.planet.x, dy = world.y - state.planet.y;
        if(Math.hypot(dx,dy) <= state.planet.radius + 8/cam.zoom){ state.selected = {kind:'planet'}; updatePanel(); return; }
        state.selected = null; updatePanel();
      }
    });

    cvs.addEventListener('mousemove', (e)=>{
      if(panning){ const dx=(e.clientX-last.x)/cam.zoom, dy=(e.clientY-last.y)/cam.zoom; cam.x-=dx; cam.y-=dy; last.x=e.clientX; last.y=e.clientY; return; }
      if(state.placing){ const w = screenToWorld(e.clientX, e.clientY); const dx=w.x-state.planet.x, dy=w.y-state.planet.y; state.placing.r=Math.hypot(dx,dy); state.placing.angle=Math.atan2(dy,dx); }
    });

    cvs.addEventListener('mouseup', (e)=>{ if(e.button===2) panning=false; });

    // FIX: this handler was duplicated before, causing a stray '}' syntax error. Now defined once.
    cvs.addEventListener('wheel', (e)=>{
      const factor = Math.exp(-e.deltaY * 0.001);
      const mx = e.clientX, my = e.clientY; const before = screenToWorld(mx,my);
      cam.zoom = Math.min(3, Math.max(0.25, cam.zoom * factor));
      const after = screenToWorld(mx,my); cam.x += before.x-after.x; cam.y += before.y-after.y;
    }, { passive:true });

    addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='h') toggleShop(); });

    // ---------- HUD + Shop + Panel ----------
    const $money=q('#money'), $basalt=q('#basalt'), $energy=q('#energy');
    const $moons=q('#moons'), $sats=q('#sats'), $bRate=q('#bRate'), $eRate=q('#eRate'), $terr=q('#terr');
    const $pLv=q('#pLv');
    const $toast=q('#toast');
    const $shop=q('#shop'), $shopBtn=q('#shopBtn');
    const $moonCost=q('#moonCost'), $satCost=q('#satCost');
    const $sellBAmt=q('#sellBasaltAmt'), $sellEAmt=q('#sellEnergyAmt');
    const $panel=q('#panel'), $panelTitle=q('#panelTitle'), $bLvl=q('#bLvl'), $bProd=q('#bProd'), $bUpCost=q('#bUpCost');
    const $rowProd=q('#rowProd'), $rowDemo=q('#rowDemo'); const $prodLabel=q('#prodLabel');

    $shopBtn.addEventListener('click', ()=>toggleShop(true));
    q('#closeShop').addEventListener('click', ()=>toggleShop(false));
    q('#startMoon').addEventListener('mousedown', ()=>beginPlacing('moon'));
    q('#startSat').addEventListener('mousedown', ()=>beginPlacing('sat'));

    q('#sellBasalt').addEventListener('click', ()=>{
      const amt = Math.max(0, Math.floor(Number($sellBAmt.value||0)));
      if(amt<=0) return; if(state.basalt < amt) return toast('Not enough basalt.');
      state.basalt -= amt; state.money += amt * ECON.sellUnit.basalt; updateHud(); save();
    });
    q('#sellEnergy').addEventListener('click', ()=>{
      const amt = Math.max(0, Math.floor(Number($sellEAmt.value||0)));
      if(amt<=0) return; if(state.energy < amt) return toast('Not enough energy.');
      state.energy -= amt; state.money += amt * ECON.sellUnit.energy; updateHud(); save();
    });

    q('#bClose').addEventListener('click', ()=>{ state.selected=null; updatePanel(); });
    q('#bUpgrade').addEventListener('click', ()=>{
      const sel = state.selected; if(!sel) return;
      if(sel.kind==='planet'){
        if(state.planet.level>=ECON.maxLevel) return toast('Planet is max level.');
        const cost = upgradeCost('planet', state.planet.level);
        if(state.money < cost) return toast('Need '+cost+' money.');
        state.money -= cost; state.planet.level++; state.territory = ECON.territory.base + (state.planet.level-1)*ECON.territory.perLevel; updateHud(); updatePanel(); save(); return;
      }
      const list = (sel.kind==='moon'? state.moons : state.sats); const obj = list[sel.idx];
      if(obj.lvl>=ECON.maxLevel) return toast('Max level.');
      const cost = upgradeCost(sel.kind, obj.lvl);
      if(state.money < cost) return toast('Need '+cost+' money.');
      state.money -= cost; obj.lvl++; obj.spent += cost; updatePanel(); updateHud(); save();
    });
    q('#bDemo').addEventListener('click', ()=>{
      const sel = state.selected; if(!sel || sel.kind==='planet') return; const list=(sel.kind==='moon'?state.moons:state.sats); const obj=list[sel.idx];
      const refund=Math.floor(obj.spent*0.75); state.money+=refund; list.splice(sel.idx,1); state.selected=null; updatePanel(); updateHud(); save(); toast('Demolished. Refunded '+refund+'.');
    });

    function beginPlacing(kind){ const base=(kind==='moon'?ECON.moonCost:ECON.satCost); if(state.money < base){ toast('Need '+base+' money.'); return; } toggleShop(false); state.selected=null; updatePanel(); state.placing = { kind, r: Math.max(ORBIT.min, 90), angle: 0 }; }

    function toggleShop(force){ if(typeof force==='boolean') $shop.style.display = force? 'block':'none'; else $shop.style.display = ($shop.style.display==='block'?'none':'block'); }

    function isPlacementValid(r){ if(r < ORBIT.min || r > state.territory - 10) return false; const near=(a,b)=> Math.abs(a-b) < ORBIT.gap; for(const m of state.moons){ if(near(r, m.r)) return false; } for(const s of state.sats){ if(near(r, s.r)) return false; } return true; }

    function pickBuilding(wx, wy){
      // compute current world positions for moving bodies
      for(let i=0;i<state.moons.length;i++){ const m=state.moons[i]; const x=state.planet.x + Math.cos(m.angle)*m.r; const y=state.planet.y + Math.sin(m.angle)*m.r; if(Math.hypot(wx-x, wy-y) < 12/cam.zoom) return {kind:'moon', idx:i}; }
      for(let i=0;i<state.sats.length;i++){ const s=state.sats[i]; const x=state.planet.x + Math.cos(s.angle)*s.r; const y=state.planet.y + Math.sin(s.angle)*s.r; if(Math.hypot(wx-x, wy-y) < 12/cam.zoom) return {kind:'sat', idx:i}; }
      return null;
    }

    function updatePanel(){
      const sel = state.selected;
      if(!sel){ $panel.style.display='none'; return; }
      $panel.style.display='block';
      if(sel.kind==='planet'){
        $panelTitle.textContent = 'Planet';
        $bLvl.textContent = state.planet.level; $bUpCost.textContent = (state.planet.level>=ECON.maxLevel? 'Max' : upgradeCost('planet', state.planet.level));
        $prodLabel.textContent = 'Territory'; $bProd.textContent = state.territory + 'u';
        $rowDemo.style.display = 'none'; // cannot demolish planet
        $rowProd.style.display = 'flex';
        return;
      }
      const list = (sel.kind==='moon'? state.moons : state.sats); const obj = list[sel.idx];
      $panelTitle.textContent = sel.kind==='moon' ? 'Moon' : 'Satellite';
      $bLvl.textContent = obj.lvl; $bUpCost.textContent = (obj.lvl>=ECON.maxLevel? 'Max' : upgradeCost(sel.kind, obj.lvl));
      $prodLabel.textContent = 'Prod'; $bProd.textContent = '+'+obj.lvl+'/s';
      $rowDemo.style.display = 'flex';
      $rowProd.style.display = 'flex';
    }

    function updateHud(){
      $money.textContent = Math.floor(state.money);
      $basalt.textContent = Math.floor(state.basalt);
      $energy.textContent = Math.floor(state.energy);
      const moonRate = state.moons.reduce((s,m)=>s+m.lvl,0); const satRate = state.sats.reduce((s,m)=>s+m.lvl,0);
      $moons.textContent = state.moons.length; $bRate.textContent = moonRate;
      $sats.textContent = state.sats.length; $eRate.textContent = satRate;
      $pLv.textContent = state.planet.level; $terr.textContent = Math.floor(state.territory);
      $moonCost.textContent = ECON.moonCost; $satCost.textContent = ECON.satCost;
      document.body.style.cursor = state.placing ? 'crosshair' : 'default';
    }

    // HUD refresh each second
    setInterval(updateHud, 1000);

    function toast(msg){ $toast.textContent = msg; $toast.style.display='block'; clearTimeout(toast._t); toast._t = setTimeout(()=>{ $toast.style.display='none'; }, 1600); }
    function q(sel){ return document.querySelector(sel); }

    updateHud();

    // ---------- Render ----------
    function drawGrid(){
      const step = 100; const minx = Math.floor(cam.x/step)*step; const miny = Math.floor(cam.y/step)*step;
      const maxx = cam.x + innerWidth / cam.zoom; const maxy = cam.y + innerHeight / cam.zoom;
      ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.beginPath();
      for(let x=minx; x<=maxx; x+=step){ const p1=worldToScreen(x, miny), p2=worldToScreen(x, maxy); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); }
      for(let y=miny; y<=maxy; y+=step){ const p1=worldToScreen(minx, y), p2=worldToScreen(maxx, y); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2,y); }
      ctx.stroke();
    }

    function draw(){
      accrue();
      const now = Date.now();
      const dt = (now - state.lastFrame)/1000; state.lastFrame = now;

      for(const m of state.moons){ m.angle += m.speed * dt; }
      for(const s of state.sats){ s.angle += s.speed * dt; }

      ctx.clearRect(0,0,innerWidth,innerHeight);
      drawGrid();

      const ps = worldToScreen(state.planet.x, state.planet.y);

      // Territory ring
      ctx.beginPath(); ctx.arc(ps.x, ps.y, state.territory*cam.zoom, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(80,200,255,0.08)'; ctx.fill();
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(80,200,255,.6)'; ctx.stroke();

      // Planet (highlight if selected)
      ctx.beginPath(); ctx.arc(ps.x, ps.y, state.planet.radius*cam.zoom, 0, Math.PI*2);
      const grad = ctx.createRadialGradient(ps.x-6, ps.y-6, 6, ps.x, ps.y, state.planet.radius*cam.zoom);
      grad.addColorStop(0,'#4fd1c5'); grad.addColorStop(1,'#2563eb');
      ctx.fillStyle = grad; ctx.fill();
      ctx.lineWidth = (state.selected && state.selected.kind==='planet') ? 4 : 2;
      ctx.strokeStyle = (state.selected && state.selected.kind==='planet') ? '#3cf' : 'rgba(0,0,0,.35)';
      ctx.stroke();

      // Only draw orbit path for the **selected** object (cleaner view), and the placement preview
      if(state.selected && state.selected.kind!=='planet'){
        const sel = state.selected; const list = (sel.kind==='moon'? state.moons : state.sats); const obj = list[sel.idx];
        if(obj){ ctx.lineWidth = 1.5; ctx.strokeStyle = 'rgba(255,255,255,.25)'; ctx.beginPath(); ctx.arc(ps.x, ps.y, obj.r*cam.zoom, 0, Math.PI*2); ctx.stroke(); }
      }

      // Moons
      for(let i=0;i<state.moons.length;i++){
        const m=state.moons[i]; const x=state.planet.x + Math.cos(m.angle)*m.r; const y=state.planet.y + Math.sin(m.angle)*m.r; const p=worldToScreen(x,y);
        ctx.beginPath(); ctx.arc(p.x,p.y,10,0,Math.PI*2); ctx.fillStyle='#bdbdbd'; ctx.fill();
        ctx.strokeStyle=(state.selected&&state.selected.kind==='moon'&&state.selected.idx===i)?'#3cf':'#8a8a8a';
        ctx.lineWidth=(state.selected&&state.selected.kind==='moon'&&state.selected.idx===i)?3:1.5; ctx.stroke();
      }
      // Satellites
      for(let i=0;i<state.sats.length;i++){
        const s=state.sats[i]; const x=state.planet.x + Math.cos(s.angle)*s.r; const y=state.planet.y + Math.sin(s.angle)*s.r; const p=worldToScreen(x,y);
        ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.fillStyle='#ffd54f'; ctx.fill();
        ctx.strokeStyle=(state.selected&&state.selected.kind==='sat'&&state.selected.idx===i)?'#3cf':'#c9a227';
        ctx.lineWidth=(state.selected&&state.selected.kind==='sat'&&state.selected.idx===i)?3:1.5; ctx.stroke();
      }

      // Placement preview (with its path)
      if(state.placing){
        const valid = isPlacementValid(state.placing.r);
        ctx.beginPath(); ctx.arc(ps.x, ps.y, state.placing.r*cam.zoom, 0, Math.PI*2);
        ctx.lineWidth = 2; ctx.strokeStyle = valid ? 'rgba(122,255,150,.9)' : 'rgba(255,80,80,.9)'; ctx.stroke();
        const gx = state.planet.x + Math.cos(state.placing.angle)*state.placing.r; const gy = state.planet.y + Math.sin(state.placing.angle)*state.placing.r; const gp = worldToScreen(gx, gy);
        ctx.beginPath(); const rad = state.placing.kind==='moon'?10:8; ctx.arc(gp.x,gp.y,rad,0,Math.PI*2); ctx.fillStyle = valid ? 'rgba(200,255,200,.7)' : 'rgba(255,120,120,.7)'; ctx.fill();
      }

      requestAnimationFrame(draw);
    }
    draw();

    // autosave
    setInterval(save, 4000);

    // ---------- Self-tests (runtime) ----------
    (function runSelfTests(){
      try {
        console.groupCollapsed('PlanetForge self-tests');
        console.assert(!!document.querySelector('#shopBtn'), 'shopBtn exists');
        console.assert(typeof toggleShop === 'function', 'toggleShop exists');
        console.assert(typeof beginPlacing === 'function', 'beginPlacing exists');
        console.assert(typeof window.on === 'undefined', 'no stray on() helper');

        // Ensure panel mousedown does not deselect (handlers bound to canvas only)
        const keepSel = state.selected; state.selected = {kind:'planet'};
        document.querySelector('#panel').dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
        console.assert(state.selected && state.selected.kind==='planet', 'panel mousedown does not deselect');

        // Upgrade & demolish flows (non-destructive; restore after)
        const backup = {
          money: state.money,
          moons: JSON.parse(JSON.stringify(state.moons)),
          sats: JSON.parse(JSON.stringify(state.sats)),
          selected: state.selected && JSON.parse(JSON.stringify(state.selected)),
          planetLvl: state.planet.level,
          territory: state.territory
        };

        // Add a moon and test upgrade
        state.money = 999999;
        state.moons.push({ r:120, angle:0, speed:orbitSpeed(120), lvl:1, spent: ECON.moonCost });
        state.selected = {kind:'moon', idx: state.moons.length-1};
        updatePanel();
        const upCost = upgradeCost('moon', 1);
        const mBefore = state.money;
        document.querySelector('#bUpgrade').click();
        console.assert(state.moons[state.moons.length-1].lvl === 2, 'Upgrade increases building level');
        console.assert(state.money === mBefore - upCost, 'Upgrade deducts correct money');

        // Demolish and verify refund
        const spent = state.moons[state.moons.length-1].spent;
        const refund = Math.floor(spent * 0.75);
        const moneyBeforeDemo = state.money;
        document.querySelector('#bDemo').click();
        console.assert(state.moons.length === backup.moons.length, 'Demolish removes the building');
        console.assert(state.money === moneyBeforeDemo + refund, 'Demolish refunds 75%');

        // Planet upgrade test
        state.selected = {kind:'planet'}; updatePanel();
        const pLv0 = state.planet.level; const pCost = upgradeCost('planet', pLv0);
        state.money = 999999;
        document.querySelector('#bUpgrade').click();
        console.assert(state.planet.level === pLv0 + 1, 'Planet upgrade increases level');
        console.assert(state.territory === ECON.territory.base + (state.planet.level-1)*ECON.territory.perLevel, 'Territory matches planet level');

        // Restore
        state.money = backup.money;
        state.moons = backup.moons;
        state.sats = backup.sats;
        state.selected = backup.selected;
        state.planet.level = backup.planetLvl;
        state.territory = backup.territory;
        updateHud(); updatePanel();

        console.groupEnd();
      } catch (e) { console.warn('Self-tests error', e); }
    })();
  </script>
</body>
</html>
